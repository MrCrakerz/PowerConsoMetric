{% extends 'base.html.twig' %}

{% block title %}Hello UploadController!{% endblock %}

{% block body %}
<style>
    .example-wrapper { margin: 1em auto; max-width: 800px; width: 95%; font: 18px/1.5 sans-serif; }
    .example-wrapper code { background: #F5F5F5; padding: 2px 6px; }
</style>

<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script>
  var tableauMoyenne = {};
  var compteurMoyenne = 0;
  var compteurMesureMoyenneActuelle = 1;
  {%set mesurePrec = ''%}
  var nomFonctionPrec='';
  var mesureTotale = 0;
  var derniereMesure = 0;
  var boolPremiereMesure =0;
  var premiereMesure =0;
  var différenceTmps=0;
  var consoTotale;

  google.charts.load('current', {packages: ['corechart', 'line']});
  google.charts.setOnLoadCallback(drawBackgroundColor)

  function removeSpecialChars(str) {
    return str.replace(/(?!\w|\s)./g, '')
      .replace(/\s+/g, ' ')
      .replace(/^(\s*)([\W\w]*)(\b\s*$)/g, '$2');
  }
  function timeConverter(UNIX_timestamp){
    var a = new Date(UNIX_timestamp * 1000);
    var hour = a.getHours();
    var min = a.getMinutes();
    var sec = a.getSeconds();
    var time = hour + ':' + min + ':' + sec ;
    return time;
  }

/*  function drawChart(nomMesure, consoMesure)
   {
            // Define the chart to be drawn.
            var data = google.visualization.arrayToDataTable([
               ['Year', 'Asia'],
               ['2012',  900],
               ['2013',  1000],
               ['2014',  1170],
               ['2015',  1250],
               ['2016',  1530]
            ]);

            var options = {title: 'Population (in millions)'};

            // Instantiate and draw the chart.
            var chart = new google.visualization.ColumnChart(document.getElementById(nomMesure));
            chart.draw(data, options);
         }

         google.charts.setOnLoadCallback(drawChart);
*/

function drawBackgroundColor()
{
      var data = new google.visualization.DataTable();
      data.addColumn('string', 'X');
      data.addColumn('number', 'Consommation');

      data.addRows([
          {%for mesure in tableauHote%}
        [timeConverter({{mesure.date}}),Math.pow(10,-6)*{{mesure.conso}}],
        {%endfor%}
      ]);
      compteurHost = 0;
      {%for mesure in tableauHote%}
      mesureToale = mesureTotale + {{mesure.conso}};
      compteurHost ++;
    {%endfor%}
    mesureTotale = mesureToale*Math.pow(10,-3);
    moyenneHost = mesureTotale/compteurHost;
    document.getElementById("hostConsoMoyenne").innerHTML = moyenneHost;

      var options = {
        hAxis: {
          title: 'Time'
        },
        vAxis: {
          title: 'Puissance (watts)'
        },
        backgroundColor: '#f1f8e9'
      };

      var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
      chart.draw(data, options);
}

function determinerAffichage (nomMesure, consoMesure, dateMesure)
      {
        //nomMesure = removeSpecialChars(nomMesure);
        if (nomFonctionPrec=="")
        {
          nomFonctionPrec=nomMesure;
          compteurMoyenne=1;
        }
        if(nomMesure==nomFonctionPrec)
        {
          if(boolPremiereMesure==0)
          {
            premiereMesure=dateMesure;
            boolPremiereMesure=1;
          }
          else {
            derniereMesure = dateMesure;
            compteurMoyenne++;
          }
          mesureTotale= mesureTotale + consoMesure;

        }
        else {

                différenceTmps = (derniereMesure-premiereMesure);
                mesureTotale = mesureTotale*Math.pow(10,-6);
                //mesureTotale = Math.round(mesureTotale*10000)/10000;
                //alert(nomFonctionPrec+" : "+mesureTotale+" "+différenceTmps);

                consoTotale =mesureTotale*différenceTmps/compteurMoyenne;

                consoMoyenne= mesureTotale/compteurMoyenne;
                document.getElementById(nomFonctionPrec+'Moyenne').innerHTML = ("Moyenne de la consommation pour le processus " + nomFonctionPrec+" : " + consoMoyenne*Math.pow(10,3) +" MilliWatts.");

                /*tableauMoyenne= tableauMoyenne + {
                  compteurMesureMoyenneActuelle:{
                    "nom":nomFonctionPrec,
                    "consoMoyenne":consoMoyenne
                  }
                };*/


                if (consoTotale > 0)
                {
                  config = determinerVariables(nomFonctionPrec, consoTotale);
                  const myChart = new Chart (document.getElementById(nomFonctionPrec+'1'),config);
                }
                else
                {
                  document.getElementById(nomFonctionPrec+'Label').innerHTML = ("Pas de mesures significatives pour le processus : " + nomFonctionPrec);
                }

              compteurMesureMoyenneActuelle;
              compteurMoyenne = 0 ;
              nomFonctionPrec=nomMesure;
              mesureTotale = 0;
              derniereMesure = 0;
              boolPremiereMesure =0;
              premiereMesure =0;
              différenceTmps=0;
          }

        }
function determinerVariables (nomAppli,consoAppli)
{

if (consoAppli<1)
{
  grandeur = "MilliWattsHeure"
  consoAppli = consoAppli*1000;

}
else if (consoAppli > 1000) {

  grandeur = "KiloWattsHeure"
  consoAppli = consoAppli/1000;
}
else {
  grandeur = "WattsHeure"
}

const data = {
  labels: [grandeur],
  datasets: [{
    label: nomAppli,
    data: [consoAppli],
    backgroundColor: [
      'rgba(255, 99, 132, 0.2)'
    ],
    borderColor: [
      'rgb(255, 99, 132)'
    ],
    borderWidth: 1
  }]
};

const config = {
type: 'bar',
data: data,
options: {
  scales: {
    y: {
      beginAtZero: true
      }
    }
  },
};
return config;
}
function calculerExportationHote()
{
  valeurMoyenne = Number(document.getElementById('hostConsoMoyenne').textContent);
  alert ('valMoy : ' + valeurMoyenne);
  valeurMoyenne = valeurMoyenne*Math.pow(10,-3);
  nbHeure = document.getElementById('heures').value;
  alert ('nbHeure : ' + nbHeure);
  nbJours = document.getElementById('nbJours').value;
  alert (' nbJours ' + nbJours);
  valExport = valeurMoyenne * nbHeure * nbJours;
  alert (' ValeExpor : ' + valExport);
  document.getElementById('resultat').innerHTML=valExport;
}
  </script>

</head>
<body>
  <form id = "hostFormulaire">
  <div id="chart_div"class="example-wrapper">

  </div>
<label> Moyenne de la consommation instantané globale : </label>
<label type=number id="hostConsoMoyenne"></label>
<label> MilliWatts </label> <br>
<label> Exportation :     Nombre d'heures par jour </label>
<input type="number" id="heures">
<label>  Sur : </label>
<input type="number" id="nbJours">
<label>  par an.   </label>
  <label id="resultat"></label>
  <input type = 'button' value="calculer" onclick= "calculerExportationHote()">
</form>
  {% for mesure in tableauFinal %}

  {% if mesure.name != mesurePrec %}
  <div id={{mesure.name}}>
    <canvas id="{{mesure.name}}1"></canvas>
    <label id="{{mesure.name}}Label"></label>
    <label id="{{mesure.name}}Moyenne"></label><br>
    <label> Exportation :     Nombre d'heures par jour </label>
    <input type="number" id="{{mesure.name}}Heures">
    <label>  Sur : </label>
    <input type="number" id="{{mesure.name}}NbJours">
    <label>  par an.    </label>
    <label id="{{mesure.name}}Resultat"></label>
  </div>
  {% set mesurePrec = mesure.name %}
  {% endif %}


  <script>
    determinerAffichage("{{mesure.name}}",{{mesure.conso}}, {{mesure.heure}});
  </script>
  {% endfor %}
</body>
{% endblock %}
